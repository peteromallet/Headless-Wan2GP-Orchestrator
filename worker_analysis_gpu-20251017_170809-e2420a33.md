# Worker Analysis: gpu-20251017_170809-e2420a33

## Status: Model Switch Loop - Not Completing

**Issue**: Worker is stuck in an infinite loop trying to switch from `t2v` to `lightning_baseline_2_2_2` model but never completes the switch.

## Timeline Analysis

### Phase 1: Successful Task Completion ‚úÖ
```
[INFO] 873033+0 | TRAVEL: [RAM] Before VLM loading: Process=539MB (0.53GB)
[INFO] 533637+0 | HEADLESS: ‚úÖ [HEARTBEAT] Worker active (1 heartbeats sent)
[INFO] 014188+0 | TRAVEL: [RAM] After VLM cleanup: Process=2055MB (2.01GB)
[INFO] 790205+0 | TRAVEL: Successfully enqueued 1 new segment tasks and 1 new stitch task for run 20251017170726408
[INFO] 792372+0 | TRAVEL: [RAM] Orchestrator end (success): Process=2055MB (2.01GB)
```

### Phase 2: New Task Processing - Configuration Success ‚úÖ
```
[INFO] 592106+0 | HEADLESS: Found task of type: travel_segment, Project ID: f3c36ed6-eeb4-4259-8f67-b8260efd1c0e
[INFO] 596073+0 | HEADLESS: Processing travel_segment task
[INFO] 612648+0 | HEADLESS: [RAM] Segment via queue - start: Process=2055MB (2.01GB)
[INFO] 026982+0 | HEADLESS: [DEBUG] Checking for phase_config. Keys in full_orchestrator_payload: ['run_id', 'shot_id', 'seed_base', 'flow_shift', 'lora_names', 'model_name', 'base_prompt', 'phase_config', 'advanced_mode', 'apply_causvid']
[INFO] 028038+0 | HEADLESS: phase_config detected in orchestrator payload - parsing comprehensive phase override
[INFO] 029029+0 | HEADLESS: phase_config overriding num_inference_steps: 6 (from steps_per_phase [2, 2, 2])
[INFO] 036817+0 | HEADLESS: üì¶ Prepared phase_config patch for 'lightning_baseline_2_2_2': 3 phases, cleared built-in LoRAs, flow_shift=7, solver=euler (will apply before generation)
[INFO] 037594+0 | HEADLESS: phase_config parsed: 3 phases, steps=[2, 2, 2], thresholds=[939.3673095703125, 730.7052001953125], 3 LoRAs, lora_multipliers=['0.75;1.0;0', '0;0.25;0', '0;0;1.0']
[INFO] 067133+0 | HEADLESS: ‚úÖ Patched wgp.models_def['lightning_baseline_2_2_2'] in memory: 3 phases, cleared built-in LoRAs, flow_shift=7, solver=euler
[INFO] 068904+0 | HEADLESS: [PHASE_CONFIG] Patched wgp.models_def for model 'lightning_baseline_2_2_2': cleared built-in LoRAs, guidance_phases=3 (will also be re-applied in GenerationWorker after orchestrator init if needed)
[INFO] 070153+0 | HEADLESS: phase_config applied: 3 phases, steps=6, guidance=[3, 1, 1], flow_shift=7, 3 LoRAs, lora_multipliers=['0.75;1.0;0', '0;0.25;0', '0;0;1.0']
[INFO] 073875+0 | HEADLESS: [RAM] Before queue submission: Process=2098MB (2.05GB) | System=34.2% used, 165.4GB/251.6GB available
```

### Phase 3: Model Switch Loop - STUCK ‚ùå
```
[INFO] 740111+0 | ORCHESTRATOR: WanOrchestrator initialized with WGP at /workspace/Headless-Wan2GP/Wan2GP
[INFO] 744244+0 | MODEL: üîÑ MODEL SWITCH: Using WGP's generate_video pattern - switching from (current: t2v) to lightning_baseline_2_2_2
[INFO] 764131+0 | HEADLESS: ‚úÖ [HEARTBEAT] Worker gpu-20251017_170809-e2420a33 active (16 heartbeats sent)
```

**This sequence repeats infinitely - worker never progresses past model switch**

## Problem Analysis

### What's Working ‚úÖ
- Worker heartbeat system
- Task discovery and parsing
- Phase configuration parsing and application
- Memory management (RAM tracking)
- WanOrchestrator initialization

### What's Broken ‚ùå
- **Model switch completion**: Gets stuck switching from `t2v` to `lightning_baseline_2_2_2`
- **Queue submission**: Never actually submits to processing queue
- **Task progression**: Cannot move past initialization phase

### Configuration Details
- **Target Model**: `lightning_baseline_2_2_2`
- **Current Model**: `t2v`
- **Phases**: 3 phases with steps [2, 2, 2]
- **LoRAs**: 3 LoRAs with multipliers `['0.75;1.0;0', '0;0.25;0', '0;0;1.0']`
- **Flow Shift**: 7
- **Solver**: euler
- **Memory Usage**: Stable at ~2GB

## Potential Root Causes

1. **Model Loading Issue**: `lightning_baseline_2_2_2` model may not be available or corrupted
2. **GPU Memory**: Model switch may require more GPU memory than available
3. **Path Issue**: WGP path `/workspace/Headless-Wan2GP/Wan2GP` may have access issues
4. **Configuration Conflict**: Complex phase config may be incompatible with model switch
5. **Deadlock**: Race condition between orchestrator init and model switch

## Recommended Actions

1. Check if `lightning_baseline_2_2_2` model exists and is accessible
2. Monitor GPU memory usage during model switch attempt
3. Verify WGP path permissions and accessibility
4. Review model switch implementation for deadlock conditions
5. Consider worker restart if issue persists

## Current Status
- **Worker State**: Alive but stuck in loop
- **RAM Usage**: 2.05GB (stable)
- **Heartbeats**: Active (16+ sent)
- **Last Progress**: Successfully completed previous travel_segment task